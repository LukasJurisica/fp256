name: cmake-CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build_test:

    name: ${{matrix.toolchain}}
    runs-on: ${{matrix.os}}

    strategy:
      matrix:
        toolchain:
          - linux-gcc
          - linux-clang
          - macos-clang

        configuration:
          - -DCMAKE_BUILD_TYPE=Release -DUSE_ASAN=ON
          - -DCMAKE_BUILD_TYPE=Debug   -DUSE_ASAN=ON

        include:
          - toolchain: linux-gcc
            os: ubuntu-latest
            compiler: gcc

          - toolchain: linux-clang
            os: ubuntu-latest
            compiler: clang

          - toolchain: macos-clang
            os: macos-10.15
            compiler: clang

    steps:
      - uses: actions/checkout@v2

      - name: configure
        run: mkdir build && cd build && cmake .. ${{matrix.configuration}}

      - name: build
        run: cd build && make -j
      
      - name: test
        run: cd build && make test
